<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>PDF/MD åŒé¢æ‰“å°ä¿®å¤ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>

    <style>
        /* ---------- åŸºç¡€æ ·å¼ ---------- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body {
            margin: 0; padding: 0; height: 100%;
            font-family: sans-serif; background-color: #f2f4f7; overflow: hidden;
        }
        
        .app-container { display: flex; flex-direction: column; height: 100%; }

        /* é¡¶éƒ¨ Tab */
        .tabs {
            display: flex; background: #fff; border-bottom: 1px solid #ddd;
            height: 44px; flex-shrink: 0; z-index: 20;
        }
        .tab-item {
            flex: 1; display: flex; align-items: center; justify-content: center;
            font-size: 14px; color: #666; cursor: pointer; border-bottom: 2px solid transparent;
        }
        .tab-item.active { color: #007bff; border-bottom-color: #007bff; font-weight: bold; }

        /* å†…å®¹åŒº */
        .content-area { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }

        /* ç¼–è¾‘å™¨ & ä¸Šä¼ åŒº */
        #pane-editor, #pane-upload { display: none; flex-direction: column; height: 100%; background: #fff; }
        #pane-editor.active, #pane-upload.active { display: flex; }
        
        textarea {
            flex: 1; width: 100%; border: none; padding: 15px; font-size: 16px; resize: none; outline: none;
        }

        .upload-box {
            border: 2px dashed #ccc; border-radius: 10px; margin: 20px;
            flex: 1; max-height: 200px; display: flex; flex-direction: column;
            align-items: center; justify-content: center; background: #fafafa; color: #666;
        }
        .file-list { padding: 0 20px; font-size: 13px; color: #333; overflow-y: auto; flex: 1; }
        .file-item { border-bottom: 1px solid #eee; padding: 8px 0; display: flex; justify-content: space-between; }

        /* é¢„è§ˆåŒº */
        #pane-preview {
            display: none; flex-direction: column; height: 100%;
            background: #525659; overflow-y: auto; padding: 20px 0 100px 0;
            align-items: center; position: absolute; top: 0; left: 0; width: 100%; z-index: 50;
        }
        #pane-preview.active { display: flex; }

        .scaler-container {
            transform-origin: top center; transition: transform 0.2s ease;
            display: flex; flex-direction: column; gap: 20px;
        }

        /* çº¸å¼ æ ·å¼ */
        .sheet {
            width: 210mm; min-height: 297mm; /* é¢„è§ˆæ—¶ä¿æŒA4æ¯”ä¾‹ */
            background: white; position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            display: flex; flex-direction: column;
        }

        /* æ–‡æœ¬æ¨¡å¼æœ‰è¾¹è·ï¼Œå›¾ç‰‡æ¨¡å¼æ— è¾¹è· */
        .sheet.text-mode { padding: 20mm; }
        .sheet.image-mode { padding: 0; justify-content: center; align-items: center; }

        /* ä¿®å¤ Canvas æ¨¡ç³Šé—®é¢˜ */
        canvas { max-width: 100%; height: auto; display: block; }
        img { max-width: 100%; max-height: 100%; object-fit: contain; }

        /* é¡µç  */
        .page-number {
            position: absolute; bottom: 5px; left: 0; width: 100%;
            text-align: center; color: #999; font-size: 10px; pointer-events: none;
        }

        /* åº•éƒ¨æ  */
        .bottom-bar {
            background: #fff; border-top: 1px solid #e0e0e0;
            padding: 10px; z-index: 100;
        }
        .controls-row { display: flex; justify-content: space-between; align-items: center; }
        .btn {
            border: 1px solid #ddd; background: #fff; padding: 8px 12px;
            border-radius: 4px; font-size: 13px; cursor: pointer; margin-left: 5px;
        }
        .btn-primary { background: #007bff; color: #fff; border-color: #007bff; }
        .btn-active { background: #e7f1ff; color: #007bff; border-color: #007bff; font-weight: bold; }

        /* è¾…åŠ©å…ƒç´  */
        #temp-renderer { position: absolute; top: 0; left: 0; width: 170mm; visibility: hidden; pointer-events: none; }
        .loading-mask {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.7); color: white; display: flex;
            align-items: center; justify-content: center; z-index: 999;
            flex-direction: column;
        }
        
        .markdown-body { font-size: 11pt; line-height: 1.5; }

        /* =========================================
           æ‰“å°æ ¸å¿ƒä¿®å¤ (v3.0)
           ========================================= */
        @media print {
            /* 1. éšè—æ‰€æœ‰ UI */
            .tabs, #pane-editor, #pane-upload, .bottom-bar, .loading-mask { display: none !important; }
            
            /* 2. é‡ç½®å®¹å™¨ */
            html, body, .app-container, #pane-preview, .scaler-container {
                display: block !important; position: static !important;
                background: white !important; overflow: visible !important;
                height: auto !important; width: 100% !important;
                margin: 0 !important; padding: 0 !important;
            }

            .scaler-container { transform: none !important; }

            /* 3. çº¸å¼ æ ·å¼ä¿®å¤ */
            .sheet {
                margin: 0 !important; box-shadow: none !important; border: none !important;
                width: 100% !important; 
                /* å…³é”®ä¿®å¤ï¼šä¸è¦è®¾ç½® height: 100%ï¼Œæ”¹ä¸º auto æˆ– min-height */
                height: auto !important; 
                min-height: 297mm !important;
                page-break-after: always; /* å¼ºåˆ¶åˆ†é¡µ */
                page-break-inside: avoid;
            }

            /* 4. å¥‡å¶é¡µæ§åˆ¶ (ä½¿ç”¨ JS Class æ ‡è®°ï¼Œè€Œé nth-child) */
            /* å¦‚æœæ¨¡å¼æ˜¯æ‰“å°å¥‡æ•°é¡µï¼Œéšè—æ‰€æœ‰ class åŒ…å« sheet-even çš„å…ƒç´  */
            body.print-odd .sheet-even { display: none !important; }
            
            /* å¦‚æœæ¨¡å¼æ˜¯æ‰“å°å¶æ•°é¡µï¼Œéšè—æ‰€æœ‰ class åŒ…å« sheet-odd çš„å…ƒç´  */
            body.print-even .sheet-odd { display: none !important; }

            @page { size: A4; margin: 0; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="tabs">
        <div class="tab-item active" onclick="setTab('editor')">ğŸ“ Markdown</div>
        <div class="tab-item" onclick="setTab('upload')">ğŸ“‚ PDF / å›¾ç‰‡</div>
    </div>

    <div class="content-area">
        <div id="pane-editor" class="active">
            <textarea id="input" placeholder="è¾“å…¥ Markdown..."></textarea>
        </div>

        <div id="pane-upload">
            <label class="upload-box">
                <div style="font-size: 30px;">ğŸ“„</div>
                <div>ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
                <input type="file" id="fileInput" multiple accept=".pdf,image/*" style="display: none;">
            </label>
            <div class="file-list" id="fileList"></div>
        </div>

        <div id="pane-preview">
            <div class="scaler-container" id="scaler"></div>
        </div>
    </div>

    <div id="temp-renderer" class="markdown-body"></div>

    <!-- åŠ è½½é®ç½© -->
    <div id="loading" class="loading-mask" style="display: none;">
        <div style="font-size: 20px;">æ­£åœ¨è§£æ...</div>
        <div id="loading-text" style="font-size: 14px; margin-top: 10px;">0%</div>
    </div>

    <div class="bottom-bar">
        <div class="controls-row">
            <div id="statusInfo" style="font-size: 12px; color: #666;">å‡†å¤‡å°±ç»ª</div>
            
            <!-- ç¼–è¾‘æ  -->
            <div id="btnGroupEdit">
                <button class="btn btn-primary" onclick="startPreview()">é¢„è§ˆç”Ÿæˆ</button>
            </div>

            <!-- é¢„è§ˆæ  -->
            <div id="btnGroupPreview" style="display:none;">
                <button class="btn" onclick="exitPreview()">è¿”å›</button>
                <button class="btn btn-active" id="btnAll" onclick="setPrintMode('all')">å…¨éƒ¨</button>
                <button class="btn" id="btnOdd" onclick="setPrintMode('odd')">å¥‡æ•°é¡µ</button>
                <button class="btn" id="btnEven" onclick="setPrintMode('even')">å¶æ•°é¡µ</button>
                <button class="btn btn-primary" onclick="window.print()">ğŸ–¨ï¸ æ‰“å°</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentTab = 'editor';
    let uploadedFiles = [];
    const input = document.getElementById('input');
    const scaler = document.getElementById('scaler');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const statusInfo = document.getElementById('statusInfo');
    const loading = document.getElementById('loading');
    const loadingText = document.getElementById('loading-text');

    input.value = `# åŒé¢æ‰“å°ä¿®å¤ç‰ˆ V3

æ­¤ç‰ˆæœ¬ä¿®å¤äº†"æ‰“å°å¥‡å¶é¡µæ—¶åªæ˜¾ç¤ºä¸€é¡µ"çš„ Bugã€‚

1. **æµ‹è¯• Markdown**ï¼šç›´æ¥è¾“å…¥æ–‡å­—ï¼Œç‚¹å‡»é¢„è§ˆã€‚
2. **æµ‹è¯• PDF**ï¼šåˆ‡æ¢ä¸Šæ–¹æ ‡ç­¾ï¼Œä¸Šä¼ ä¸€ä¸ªå¤§äº5é¡µçš„ PDFã€‚
3. **æ‰“å°æµç¨‹**ï¼š
   - é¢„è§ˆåï¼Œç‚¹å‡» "å¥‡æ•°é¡µ"ã€‚
   - æ­¤æ—¶å±å¹•ä¸Šåº”è¯¥æ˜¾ç¤ºç¬¬ 1, 3, 5... é¡µã€‚
   - æ‰“å° -> ç¿»é¢ã€‚
   - ç‚¹å‡» "å¶æ•°é¡µ"ï¼Œæ˜¾ç¤ºç¬¬ 2, 4, 6... é¡µã€‚
   - æ‰“å°ã€‚
`;

    function setTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-item')[tab === 'editor' ? 0 : 1].classList.add('active');
        document.getElementById('pane-editor').classList.remove('active');
        document.getElementById('pane-upload').classList.remove('active');
        document.getElementById(`pane-${tab}`).classList.add('active');
    }

    fileInput.addEventListener('change', (e) => {
        uploadedFiles = Array.from(e.target.files);
        fileList.innerHTML = '';
        uploadedFiles.forEach(f => {
            fileList.innerHTML += `<div class="file-item"><span>${f.name}</span><span>${(f.size/1024).toFixed(0)}KB</span></div>`;
        });
        statusInfo.innerText = `å·²é€‰ ${uploadedFiles.length} ä¸ªæ–‡ä»¶`;
    });

    async function startPreview() {
        loading.style.display = 'flex';
        loadingText.innerText = 'å‡†å¤‡ä¸­...';
        
        document.getElementById('pane-preview').classList.add('active');
        document.getElementById('btnGroupEdit').style.display = 'none';
        document.getElementById('btnGroupPreview').style.display = 'flex';
        setPrintMode('all');
        scaler.innerHTML = '';

        try {
            if (currentTab === 'editor') {
                processMarkdown();
            } else {
                await processFiles();
            }
            setTimeout(fitToScreen, 100);
        } catch (e) {
            alert('å¤„ç†å‡ºé”™: ' + e.message);
        } finally {
            loading.style.display = 'none';
        }
    }

    function exitPreview() {
        document.getElementById('pane-preview').classList.remove('active');
        document.getElementById('btnGroupEdit').style.display = 'block';
        document.getElementById('btnGroupPreview').style.display = 'none';
    }

    function processMarkdown() {
        const temp = document.getElementById('temp-renderer');
        temp.innerHTML = marked.parse(input.value);
        const MAX_HEIGHT = 960; 
        
        let pageIndex = 1;
        let sheet = createSheet(pageIndex, 'text');
        let currentH = 0;
        let container = sheet.querySelector('.markdown-body');
        scaler.appendChild(sheet);

        Array.from(temp.children).forEach(el => {
            const h = el.getBoundingClientRect().height;
            const style = window.getComputedStyle(el);
            const totalH = h + parseFloat(style.marginTop) + parseFloat(style.marginBottom);
            
            if (currentH + totalH > MAX_HEIGHT) {
                pageIndex++;
                sheet = createSheet(pageIndex, 'text');
                container = sheet.querySelector('.markdown-body');
                scaler.appendChild(sheet);
                currentH = 0;
            }
            container.appendChild(el);
            currentH += totalH;
        });
        statusInfo.innerText = `å…± ${pageIndex} é¡µ`;
    }

    async function processFiles() {
        let globalPageIndex = 0;
        for (const file of uploadedFiles) {
            if (file.type === 'application/pdf') {
                const data = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(data).promise;
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    globalPageIndex++;
                    loadingText.innerText = `æ­£åœ¨æ¸²æŸ“ PDF: ${i} / ${pdf.numPages}`;
                    
                    const page = await pdf.getPage(i);
                    const sheet = createSheet(globalPageIndex, 'image');
                    const viewport = page.getViewport({ scale: 2 }); // 2å€ç¼©æ”¾ä¿è¯æ‰“å°æ¸…æ™°
                    
                    const canvas = document.createElement('canvas');
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    
                    await page.render({
                        canvasContext: canvas.getContext('2d'),
                        viewport: viewport
                    }).promise;

                    sheet.appendChild(canvas);
                    scaler.appendChild(sheet);
                }
            } else if (file.type.startsWith('image/')) {
                globalPageIndex++;
                const sheet = createSheet(globalPageIndex, 'image');
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                sheet.appendChild(img);
                scaler.appendChild(sheet);
            }
        }
        statusInfo.innerText = `å…± ${globalPageIndex} é¡µ`;
    }

    // æ ¸å¿ƒä¿®æ”¹ï¼šæ˜ç¡®åŠ ä¸Šå¥‡å¶æ ‡è®°
    function createSheet(index, mode) {
        const div = document.createElement('div');
        // æ·»åŠ  sheet-odd æˆ– sheet-even ç±»
        const isOdd = index % 2 !== 0;
        div.className = `sheet ${mode === 'text' ? 'text-mode' : 'image-mode'} ${isOdd ? 'sheet-odd' : 'sheet-even'}`;
        
        if (mode === 'text') {
            const body = document.createElement('div');
            body.className = 'markdown-body';
            div.appendChild(body);
        }
        
        const num = document.createElement('div');
        num.className = 'page-number';
        num.innerText = `- ${index} -`;
        div.appendChild(num);
        
        return div;
    }

    function setPrintMode(mode) {
        document.body.classList.remove('print-odd', 'print-even');
        ['btnAll', 'btnOdd', 'btnEven'].forEach(id => document.getElementById(id).classList.remove('btn-active'));
        
        if (mode === 'all') document.getElementById('btnAll').classList.add('btn-active');
        if (mode === 'odd') {
            document.body.classList.add('print-odd');
            document.getElementById('btnOdd').classList.add('btn-active');
        }
        if (mode === 'even') {
            document.body.classList.add('print-even');
            document.getElementById('btnEven').classList.add('btn-active');
        }
    }

    function fitToScreen() {
        const width = window.innerWidth - 20;
        const scale = Math.min(width / 794, 1);
        scaler.style.transform = `scale(${scale})`;
        scaler.style.marginBottom = `-${(1-scale)*100}%`;
    }
    window.addEventListener('resize', fitToScreen);
</script>
</body>
</html>