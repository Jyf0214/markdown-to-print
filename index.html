<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown A4 ç¼–è¾‘å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* ---------- åŸºç¡€æ ·å¼ (å±å¹•æµè§ˆç”¨) ---------- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html, body {
            margin: 0; padding: 0;
            height: 100%; /* å±å¹•ä¸Šå æ»¡å…¨å± */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f2f4f7;
            overflow: hidden; /* å±å¹•ä¸Šç¦æ­¢æ•´ä½“æ»šåŠ¨ */
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* ç¼–è¾‘å™¨ */
        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
            overflow: hidden;
        }

        textarea {
            flex: 1;
            width: 100%;
            border: none;
            padding: 20px;
            font-size: 16px;
            line-height: 1.6;
            resize: none;
            outline: none;
            background: #fff;
            color: #333;
        }

        /* é¢„è§ˆåŒº */
        .preview-area {
            flex: 1;
            display: none; /* é»˜è®¤éšè— */
            background: #525659;
            overflow-y: auto; /* å±å¹•ä¸Šå…è®¸å†…éƒ¨æ»šåŠ¨ */
            align-items: flex-start;
            justify-content: center;
            padding-top: 20px;
            padding-bottom: 80px;
        }

        /* ç¼©æ”¾å®¹å™¨ */
        .a4-scaler {
            transform-origin: top center;
            transition: transform 0.2s ease;
        }

        /* çº¸å¼ æœ¬ä½“ */
        .a4-page {
            width: 210mm;
            min-height: 297mm;
            background: white;
            padding: 20mm;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            color: #000;
            /* å…³é”®ï¼šè®©å†…å®¹æ’‘å¼€é«˜åº¦ï¼Œè€Œä¸æ˜¯å›ºå®š */
            height: auto; 
        }

        /* åº•éƒ¨æ“ä½œæ  */
        .bottom-bar {
            height: 60px;
            background: #fff;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
            flex-shrink: 0; /* é˜²æ­¢è¢«æŒ¤å‹ */
        }

        /* çŠ¶æ€ä¸æŒ‰é’® */
        .status-text { font-size: 14px; color: #666; font-weight: 500; }
        .action-group { display: flex; gap: 10px; }
        .btn { border: none; border-radius: 6px; padding: 8px 16px; font-size: 14px; font-weight: 500; cursor: pointer; }
        .btn-primary { background: #007bff; color: #fff; }
        .btn-secondary { background: #f0f0f0; color: #333; }

        /* é¢„è§ˆæ¨¡å¼åˆ‡æ¢ */
        body.mode-preview .editor-area { display: none; }
        body.mode-preview .preview-area { display: flex; }

        /* Markdown æ ·å¼ */
        .markdown-body { font-size: 11pt; line-height: 1.6; }
        .markdown-body h1 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 20px; }
        .markdown-body table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .markdown-body th, .markdown-body td { border: 1px solid #ddd; padding: 8px; }
        .markdown-body pre { background: #f8f9fa; padding: 10px; white-space: pre-wrap; word-wrap: break-word; }
        .markdown-body img { max-width: 100%; }

        /* ==============================================
           å…³é”®ä¿®å¤ï¼šæ‰“å°æ ·å¼ (ä¿®å¤å¤šé¡µæˆªæ–­)
           ============================================== */
        @media print {
            /* 1. å½»åº•éšè— UI å…ƒç´  */
            .editor-area, .bottom-bar, .action-group { display: none !important; }

            /* 2. å¼ºåˆ¶é‡ç½® HTML/Body é«˜åº¦å’Œæº¢å‡º */
            html, body {
                height: auto !important;
                min-height: 0 !important;
                overflow: visible !important; /* å…è®¸æ»šåŠ¨/ç¿»é¡µ */
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* 3. é‡ç½®å¸ƒå±€å®¹å™¨ï¼Œå–æ¶ˆ Flexbox */
            .app-container {
                display: block !important;
                height: auto !important;
                overflow: visible !important;
            }

            /* 4. é‡ç½®é¢„è§ˆåŒº */
            .preview-area {
                display: block !important;
                height: auto !important;
                overflow: visible !important;
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
            }

            /* 5. ç¦ç”¨ç¼©æ”¾ï¼Œä¿è¯æ‰“å°æ¸…æ™°åº¦å’Œå®Œæ•´æ€§ */
            .a4-scaler {
                transform: none !important;
                width: 100% !important;
                height: auto !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            /* 6. çº¸å¼ æ ·å¼è°ƒæ•´ï¼šå…è®¸æ— é™å»¶ä¼¸ */
            .a4-page {
                width: 100% !important;
                height: auto !important; /* è®©å†…å®¹å†³å®šé«˜åº¦ */
                min-height: 0 !important;
                margin: 0 !important;
                padding: 0 !important; /* è¾¹è·äº¤ç»™ @page */
                box-shadow: none !important;
                border: none !important;
            }

            /* 7. æ‰“å°æœºè®¾ç½®ï¼šç”±æ‰“å°æœºæ¥ç®¡åˆ†é¡µ */
            @page {
                size: A4;
                margin: 20mm; /* ä¸Šä¸‹å·¦å³ç•™ç™½ */
            }

            /* 8. ä¼˜åŒ–åˆ†é¡µé€»è¾‘ (é˜²æ­¢æ ‡é¢˜æˆ–è¡¨æ ¼è¢«åˆ‡æ–­) */
            h1, h2, h3 { page-break-after: avoid; }
            table, pre, blockquote { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="editor-area">
            <textarea id="input"></textarea>
        </div>
        <div class="preview-area">
            <div id="scaler" class="a4-scaler">
                <div id="output" class="a4-page markdown-body"></div>
            </div>
        </div>
        <div class="bottom-bar">
            <div class="status-text" id="statusLabel">ç¼–è¾‘ä¸­</div>
            <div class="action-group">
                <input type="file" id="imageUpload" accept="image/*" multiple style="display:none;">
                <button id="btnUploadImage" class="btn btn-secondary">ä¸Šä¼ å›¾ç‰‡</button>
                <button id="btnToPreview" class="btn btn-primary">é¢„è§ˆ</button>
                <button id="btnToEdit" class="btn btn-secondary" style="display:none;">ç¼–è¾‘</button>
                <button id="btnPrint" class="btn btn-primary" style="display:none;">ğŸ–¨ï¸ æ‰“å°æ‰€æœ‰é¡µ (å•/åŒé¢)</button>
                <button id="btnPrintOdd" class="btn btn-primary" style="display:none;">æ‰“å°å¥‡æ•°é¡µ (æ­£é¢)</button>
                <button id="btnPrintEven" class="btn btn-primary" style="display:none;">æ‰“å°å¶æ•°é¡µ (åé¢)</button>
            </div>
        </div>
    </div>

    <script>
        const input = document.getElementById('input');
        const output = document.getElementById('output');
        const scaler = document.getElementById('scaler');
        const previewArea = document.querySelector('.preview-area');
        const statusLabel = document.getElementById('statusLabel');
        const btnToPreview = document.getElementById('btnToPreview');
        const btnToEdit = document.getElementById('btnToEdit');
        const btnPrint = document.getElementById('btnPrint');
        const btnPrintOdd = document.getElementById('btnPrintOdd');
        const btnPrintEven = document.getElementById('btnPrintEven');
        const imageUpload = document.getElementById('imageUpload');
        const btnUploadImage = document.getElementById('btnUploadImage');

        // ç”Ÿæˆå¤§é‡æµ‹è¯•æ–‡æœ¬ä»¥éªŒè¯å¤šé¡µæ‰“å°
        let longText = "# å¤šé¡µæ‰“å°æµ‹è¯•\n\næ­¤æ–‡æ¡£ç”¨äºæµ‹è¯•é•¿å†…å®¹æ˜¯å¦ä¼šè¢«æˆªæ–­ã€‚\n\n";
        for(let i=1; i<100; i++) longText += `æ®µè½ ${i}: è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ®µè½ï¼Œç”¨äºå¡«å……å†…å®¹ã€‚\n\n`;
        input.value = longText;

        function render() {
            output.innerHTML = marked.parse(input.value);
        }

        function fitToScreen() {
            const availableHeight = previewArea.clientHeight - 100; // approx for padding
            const pageHeight = scaler.offsetHeight;
            let scale = availableHeight / pageHeight;
            if (scale > 1) scale = 1;
            scaler.style.transform = `scale(${scale})`;
            scaler.style.marginBottom = `-${(1 - scale) * 100}%`;
        }

        function switchMode(mode) {
            if (mode === 'preview') {
                render();
                document.body.classList.add('mode-preview');
                statusLabel.innerText = "é¢„è§ˆæ¨¡å¼";
                btnToPreview.style.display = 'none';
                btnToEdit.style.display = 'block';
                btnPrint.style.display = 'block';
                btnPrintOdd.style.display = 'block';
                btnPrintEven.style.display = 'block';
                btnUploadImage.style.display = 'none';
                setTimeout(fitToScreen, 10);
            } else {
                document.body.classList.remove('mode-preview');
                statusLabel.innerText = "ç¼–è¾‘ä¸­";
                btnToPreview.style.display = 'block';
                btnToEdit.style.display = 'none';
                btnPrint.style.display = 'none';
                btnPrintOdd.style.display = 'none';
                btnPrintEven.style.display = 'none';
                btnUploadImage.style.display = 'block';
            }
        }

        function calculatePages() {
            const calib = document.createElement('div');
            calib.style.height = '1mm';
            calib.style.position = 'absolute';
            calib.style.visibility = 'hidden';
            document.body.appendChild(calib);
            const pxPerMm = calib.offsetHeight;
            document.body.removeChild(calib);

            const page = document.querySelector('.a4-page');
            const paddingMm = 20 * 2; // top + bottom
            const contentHeightPx = page.offsetHeight - (paddingMm * pxPerMm);
            const contentHeightMm = contentHeightPx / pxPerMm;
            const pageContentHeightMm = 297 - 40; // A4 height minus top/bottom margins
            const totalPages = Math.ceil(contentHeightMm / pageContentHeightMm);
            return totalPages;
        }

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ ï¼ˆæ”¯æŒæ‰¹é‡ï¼‰
        btnUploadImage.addEventListener('click', () => {
            imageUpload.click();
        });

        imageUpload.addEventListener('change', (event) => {
            const files = event.target.files;
            if (files.length > 0) {
                let markdownImages = '';
                let loadedCount = 0;

                Array.from(files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const base64 = e.target.result;
                        markdownImages += `![Uploaded Image \( {index + 1}]( \){base64})\n\n`;
                        loadedCount++;
                        if (loadedCount === files.length) {
                            input.value += markdownImages;
                            render();
                            input.focus();
                        }
                    };
                    reader.readAsDataURL(file);
                });
            }
        });

        btnToPreview.addEventListener('click', () => switchMode('preview'));
        btnToEdit.addEventListener('click', () => switchMode('edit'));

        btnPrint.addEventListener('click', () => {
            switchMode('preview');
            window.print();
        });

        btnPrintOdd.addEventListener('click', () => {
            switchMode('preview');
            const pages = calculatePages();
            let odd = [];
            for (let i = 1; i <= pages; i += 2) {
                odd.push(i);
            }
            const oddStr = odd.join(',');
            alert(`æ€»é¡µæ•°: ${pages}\nå¯¹äºæ‰‹åŠ¨åŒé¢æ‰“å°ï¼Œå…ˆæ‰“å°å¥‡æ•°é¡µ (æ­£é¢):\nè¯·åœ¨æ‰“å°å¯¹è¯æ¡†çš„â€œé¡µâ€å­—æ®µä¸­è¾“å…¥: ${oddStr}\næ‰“å°åï¼Œç¿»è½¬çº¸å¼ å †æ”¾ï¼ˆæ ¹æ®æ‰“å°æœºç±»å‹ï¼Œé•¿è¾¹æˆ–çŸ­è¾¹ç¿»è½¬ï¼‰ï¼Œç„¶åæ‰“å°å¶æ•°é¡µã€‚`);
            window.print();
        });

        btnPrintEven.addEventListener('click', () => {
            switchMode('preview');
            const pages = calculatePages();
            let even = [];
            for (let i = 2; i <= pages; i += 2) {
                even.push(i);
            }
            // å¯é€‰: even.reverse(); // å¦‚æœéœ€è¦ååºæ‰“å°å¶æ•°é¡µï¼ˆå–å†³äºæ‰“å°æœºçº¸å¼ è¿›ç»™æ–¹å¼ï¼‰
            const evenStr = even.join(',');
            alert(`æ€»é¡µæ•°: ${pages}\nå¯¹äºæ‰‹åŠ¨åŒé¢æ‰“å°ï¼Œæ¥ä¸‹æ¥æ‰“å°å¶æ•°é¡µ (åé¢):\nè¯·åœ¨æ‰“å°å¯¹è¯æ¡†çš„â€œé¡µâ€å­—æ®µä¸­è¾“å…¥: ${evenStr}\nå¦‚æœæ‚¨çš„æ‰“å°æœºéœ€è¦ååºæ‰“å°å¶æ•°é¡µï¼Œè¯·åœ¨å¯¹è¯æ¡†ä¸­é€‰æ‹©â€œåå‘æ‰“å°â€é€‰é¡¹ï¼Œæˆ–æ‰‹åŠ¨è°ƒæ•´èŒƒå›´ä¸ºååºã€‚`);
            window.print();
        });

        input.addEventListener('input', render);
        window.addEventListener('resize', fitToScreen);
        render();
    </script>
</body>
</html>