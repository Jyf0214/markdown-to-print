<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>ä¸‡èƒ½ A4 åŒé¢æ‰“å° (MD/PDF/å›¾ç‰‡)</title>
    <!-- Markdown è§£æåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- PDF è§£æåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    
    <script>
        // é…ç½® PDF.js Worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js';
    </script>

    <style>
        /* ---------- åŸºç¡€æ ·å¼ ---------- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body {
            margin: 0; padding: 0; height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f2f4f7; overflow: hidden;
        }
        
        .app-container { display: flex; flex-direction: column; height: 100%; }

        /* é¡¶éƒ¨ Tab */
        .tabs {
            display: flex; background: #fff; border-bottom: 1px solid #ddd;
            height: 44px; flex-shrink: 0;
        }
        .tab-item {
            flex: 1; display: flex; align-items: center; justify-content: center;
            font-size: 14px; color: #666; cursor: pointer; border-bottom: 2px solid transparent;
        }
        .tab-item.active { color: #007bff; border-bottom-color: #007bff; font-weight: bold; }

        /* å†…å®¹åŒºå®¹å™¨ */
        .content-area { flex: 1; position: relative; overflow: hidden; display: flex; flex-direction: column; }

        /* 1. Markdown ç¼–è¾‘å™¨ */
        #pane-editor {
            display: none; flex-direction: column; height: 100%; background: #fff;
        }
        #pane-editor.active { display: flex; }
        textarea {
            flex: 1; width: 100%; border: none; padding: 15px;
            font-size: 16px; line-height: 1.5; resize: none; outline: none;
        }

        /* 2. æ–‡ä»¶ä¸Šä¼ åŒº */
        #pane-upload {
            display: none; flex-direction: column; height: 100%; background: #fff;
            align-items: center; justify-content: center; padding: 20px;
        }
        #pane-upload.active { display: flex; }

        .upload-box {
            border: 2px dashed #ccc; border-radius: 10px;
            width: 100%; max-width: 400px; height: 200px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #fafafa; color: #666; cursor: pointer; transition: 0.2s;
        }
        .upload-box:hover { border-color: #007bff; background: #f0f7ff; }
        .file-list { margin-top: 20px; width: 100%; max-width: 400px; max-height: 150px; overflow-y: auto; font-size: 12px; }
        .file-item { display: flex; justify-content: space-between; padding: 5px; border-bottom: 1px solid #eee; }

        /* 3. é¢„è§ˆåŒº */
        #pane-preview {
            display: none; flex-direction: column; height: 100%;
            background: #525659; overflow-y: auto; padding: 20px 0 100px 0;
            align-items: center;
            position: absolute; top: 0; left: 0; width: 100%; z-index: 50;
        }
        #pane-preview.active { display: flex; }

        .scaler-container {
            transform-origin: top center; transition: transform 0.2s ease;
            display: flex; flex-direction: column; gap: 15px;
        }

        /* çº¸å¼ æ ·å¼ */
        .sheet {
            width: 210mm; height: 297mm;
            background: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            position: relative; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* çº¯æ–‡æœ¬æ¨¡å¼ä¸‹çš„ padding */
        .sheet.text-mode { padding: 20mm; }
        
        /* å›¾ç‰‡/PDF æ¨¡å¼ä¸‹çš„å¸ƒå±€ */
        .sheet.image-mode { padding: 0; justify-content: center; align-items: center; }
        .sheet.image-mode img, .sheet.image-mode canvas {
            max-width: 100%; max-height: 100%;
            object-fit: contain; /* ä¿æŒæ¯”ä¾‹ */
        }

        /* é¡µç  */
        .page-number {
            position: absolute; bottom: 10px; left: 0; width: 100%;
            text-align: center; color: #ccc; font-size: 12px; pointer-events: none;
            mix-blend-mode: multiply;
        }

        /* åº•éƒ¨æ“ä½œæ  */
        .bottom-bar {
            background: #fff; border-top: 1px solid #e0e0e0;
            padding: 10px; z-index: 100;
            display: flex; flex-direction: column; gap: 10px;
        }
        .controls-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn {
            border: 1px solid #ddd; background: #fff; padding: 8px 12px;
            border-radius: 4px; font-size: 13px; cursor: pointer;
        }
        .btn-primary { background: #007bff; color: #fff; border-color: #007bff; }
        .btn-active { background: #e7f1ff; color: #007bff; border-color: #007bff; font-weight: bold; }

        /* éšè—è®¡ç®—åŒº */
        #temp-renderer { position: absolute; top: 0; left: 0; width: 170mm; visibility: hidden; pointer-events: none; }

        /* Markdown æ ·å¼ */
        .markdown-body { font-size: 11pt; line-height: 1.5; color: #000; }
        .markdown-body img { max-width: 100%; }

        /* ---------- æ‰“å°æ ·å¼ ---------- */
        @media print {
            .tabs, .editor-area, .bottom-bar, #pane-upload, #pane-editor { display: none !important; }
            #pane-preview { display: block !important; position: static !important; background: white !important; overflow: visible !important; height: auto !important; padding: 0 !important; }
            .scaler-container { transform: none !important; width: 100% !important; }
            .sheet {
                margin: 0 !important; box-shadow: none !important; border: none !important;
                width: 100% !important; height: 100% !important;
                page-break-after: always;
            }
            body.print-odd .sheet:nth-child(even) { display: none !important; }
            body.print-even .sheet:nth-child(odd) { display: none !important; }
            @page { size: A4; margin: 0; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="tabs">
        <div class="tab-item active" onclick="setTab('editor')">ğŸ“ æ–‡å­—è¾“å…¥</div>
        <div class="tab-item" onclick="setTab('upload')">ğŸ“‚ ä¸Šä¼  PDF/å›¾</div>
    </div>

    <div class="content-area">
        <!-- Markdown ç¼–è¾‘å™¨ -->
        <div id="pane-editor" class="active">
            <textarea id="input" placeholder="è¾“å…¥ Markdown å†…å®¹..."></textarea>
        </div>

        <!-- æ–‡ä»¶ä¸Šä¼ åŒº -->
        <div id="pane-upload">
            <label class="upload-box">
                <div style="font-size: 24px; margin-bottom: 10px;">ğŸ“„ ğŸ“·</div>
                <div>ç‚¹å‡»é€‰æ‹© PDF æˆ– å›¾ç‰‡</div>
                <div style="font-size: 12px; margin-top: 5px; color: #999;">æ”¯æŒ .pdf, .jpg, .png</div>
                <input type="file" id="fileInput" multiple accept=".pdf,image/*" style="display: none;">
            </label>
            <div class="file-list" id="fileList"></div>
            <div style="margin-top: 10px; color: #666; font-size: 12px;">æç¤ºï¼šå›¾ç‰‡å°†è‡ªåŠ¨ä¸€å¼ ä¸€é¡µå±…ä¸­æ‰“å°</div>
        </div>

        <!-- é¢„è§ˆåŒº (å…¬ç”¨) -->
        <div id="pane-preview">
            <div class="scaler-container" id="scaler"></div>
        </div>
    </div>

    <!-- è¾…åŠ©æ¸²æŸ“ -->
    <div id="temp-renderer" class="markdown-body"></div>

    <!-- åº•éƒ¨æ  -->
    <div class="bottom-bar">
        <div class="controls-row">
            <div id="statusInfo" style="font-size: 12px; color: #666;">å‡†å¤‡å°±ç»ª</div>
            
            <!-- éé¢„è§ˆæ¨¡å¼æ˜¾ç¤º -->
            <div class="btn-group" id="btnGroupEdit">
                <button class="btn btn-primary" onclick="startPreview()">å¼€å§‹é¢„è§ˆ</button>
            </div>

            <!-- é¢„è§ˆæ¨¡å¼æ˜¾ç¤º -->
            <div class="btn-group" id="btnGroupPreview" style="display:none;">
                <button class="btn" onclick="exitPreview()">è¿”å›</button>
                <button class="btn btn-active" id="btnAll" onclick="setPrintMode('all')">å…¨éƒ¨</button>
                <button class="btn" id="btnOdd" onclick="setPrintMode('odd')">æ­£é¢(å¥‡)</button>
                <button class="btn" id="btnEven" onclick="setPrintMode('even')">åé¢(å¶)</button>
                <button class="btn btn-primary" onclick="window.print()">ğŸ–¨ï¸</button>
            </div>
        </div>
    </div>
</div>

<script>
    // çŠ¶æ€å˜é‡
    let currentTab = 'editor';
    let uploadedFiles = [];
    
    // DOM å…ƒç´ 
    const input = document.getElementById('input');
    const scaler = document.getElementById('scaler');
    const tempRenderer = document.getElementById('temp-renderer');
    const fileInput = document.getElementById('fileInput');
    const fileList = document.getElementById('fileList');
    const statusInfo = document.getElementById('statusInfo');

    // åˆå§‹åŒ–é»˜è®¤æ–‡æœ¬
    input.value = `# åŒé¢æ‰“å°åŠ©æ‰‹ (æ”¯æŒ PDF/å›¾ç‰‡)

1. **æ–‡å­—æ¨¡å¼**ï¼šåœ¨è¿™é‡Œè¾“å…¥ Markdownã€‚
2. **æ–‡ä»¶æ¨¡å¼**ï¼šç‚¹å‡»ä¸Šæ–¹ "ğŸ“‚ ä¸Šä¼ " æ ‡ç­¾ï¼Œé€‰æ‹© PDF æˆ–å›¾ç‰‡ã€‚
3. **æ‰“å°**ï¼šç‚¹å‡» "å¼€å§‹é¢„è§ˆ" -> é€‰æ‹© "æ­£é¢(å¥‡)" -> æ‰“å° -> ç¿»é¢ -> "åé¢(å¶)" -> æ‰“å°ã€‚

æ­¤ç‰ˆæœ¬å®Œç¾è§£å†³äº†æˆªæ–­é—®é¢˜ï¼ŒPDF å’Œå›¾ç‰‡å°†è‡ªåŠ¨é€‚é… A4 çº¸å¼ ã€‚
`;

    // åˆ‡æ¢ Tab
    function setTab(tab) {
        currentTab = tab;
        document.querySelectorAll('.tab-item').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-item')[tab === 'editor' ? 0 : 1].classList.add('active');
        
        document.getElementById('pane-editor').classList.remove('active');
        document.getElementById('pane-upload').classList.remove('active');
        document.getElementById(`pane-${tab}`).classList.add('active');
    }

    // æ–‡ä»¶é€‰æ‹©å¤„ç†
    fileInput.addEventListener('change', (e) => {
        uploadedFiles = Array.from(e.target.files);
        renderFileList();
    });

    function renderFileList() {
        fileList.innerHTML = '';
        if (uploadedFiles.length === 0) {
            fileList.innerHTML = '<div style="text-align:center; padding:10px;">æœªé€‰æ‹©æ–‡ä»¶</div>';
            return;
        }
        uploadedFiles.forEach(f => {
            const div = document.createElement('div');
            div.className = 'file-item';
            div.innerHTML = `<span>${f.name}</span><span>${(f.size/1024).toFixed(1)}KB</span>`;
            fileList.appendChild(div);
        });
        statusInfo.innerText = `å·²é€‰ ${uploadedFiles.length} ä¸ªæ–‡ä»¶`;
    }

    // ========== æ ¸å¿ƒé€»è¾‘ï¼šå¼€å§‹é¢„è§ˆ ==========
    async function startPreview() {
        // UI åˆ‡æ¢
        document.getElementById('pane-preview').classList.add('active');
        document.getElementById('btnGroupEdit').style.display = 'none';
        document.getElementById('btnGroupPreview').style.display = 'flex';
        setPrintMode('all');

        scaler.innerHTML = '<div style="color:white; padding:20px;">æ­£åœ¨å¤„ç†ï¼Œè¯·ç¨å€™...</div>';

        // æ ¹æ®å½“å‰ Tab å†³å®šå¤„ç†é€»è¾‘
        if (currentTab === 'editor') {
            processMarkdown();
        } else {
            await processFiles();
        }

        setTimeout(fitToScreen, 100);
    }

    function exitPreview() {
        document.getElementById('pane-preview').classList.remove('active');
        document.getElementById('btnGroupEdit').style.display = 'flex';
        document.getElementById('btnGroupPreview').style.display = 'none';
        statusInfo.innerText = 'å‡†å¤‡å°±ç»ª';
    }

    // é€»è¾‘ 1: å¤„ç† Markdown (å¤ç”¨ä¹‹å‰çš„åˆ†é¡µé€»è¾‘)
    function processMarkdown() {
        scaler.innerHTML = '';
        tempRenderer.innerHTML = marked.parse(input.value);
        
        // ä½¿ç”¨ç›¸å¯¹ä¿å®ˆçš„é«˜åº¦ï¼Œé¿å…æˆªæ–­
        const MAX_HEIGHT = 960; // çº¦ 257mm å‡å»ä¸€ç‚¹å®¹é”™

        let pageIndex = 1;
        let sheet = createSheet(pageIndex, 'text');
        let currentH = 0;
        let container = sheet.querySelector('.markdown-body');
        scaler.appendChild(sheet);

        Array.from(tempRenderer.children).forEach(el => {
            const h = el.offsetHeight + parseFloat(window.getComputedStyle(el).marginTop) + parseFloat(window.getComputedStyle(el).marginBottom);
            if (currentH + h > MAX_HEIGHT) {
                pageIndex++;
                sheet = createSheet(pageIndex, 'text');
                container = sheet.querySelector('.markdown-body');
                scaler.appendChild(sheet);
                currentH = 0;
            }
            container.appendChild(el);
            currentH += h;
        });
        statusInfo.innerText = `é¢„è§ˆä¸­: å…± ${pageIndex} é¡µ`;
    }

    // é€»è¾‘ 2: å¤„ç†æ–‡ä»¶ (PDF & å›¾ç‰‡)
    async function processFiles() {
        scaler.innerHTML = '';
        let totalPages = 0;

        for (const file of uploadedFiles) {
            if (file.type === 'application/pdf') {
                // å¤„ç† PDF
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                
                for (let i = 1; i <= pdf.numPages; i++) {
                    totalPages++;
                    const page = await pdf.getPage(i);
                    const sheet = createSheet(totalPages, 'image');
                    
                    // æ¸²æŸ“ PDF åˆ° Canvas
                    const canvas = document.createElement('canvas');
                    // è®¡ç®—ç¼©æ”¾ï¼šA4 å®½åº¦çº¦ä¸º 595pt (72dpi) æˆ– 2480px (300dpi)
                    // æˆ‘ä»¬ä½¿ç”¨ scale 2 ä¿è¯æ¸…æ™°åº¦
                    const viewport = page.getViewport({ scale: 2 });
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;
                    
                    const renderContext = {
                        canvasContext: canvas.getContext('2d'),
                        viewport: viewport
                    };
                    await page.render(renderContext).promise;
                    
                    sheet.appendChild(canvas);
                    scaler.appendChild(sheet);
                }

            } else if (file.type.startsWith('image/')) {
                // å¤„ç†å›¾ç‰‡
                totalPages++;
                const sheet = createSheet(totalPages, 'image');
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                sheet.appendChild(img);
                scaler.appendChild(sheet);
            }
        }
        statusInfo.innerText = `é¢„è§ˆä¸­: å…± ${totalPages} é¡µ`;
    }

    // åˆ›å»ºçº¸å¼ 
    function createSheet(index, mode) {
        const div = document.createElement('div');
        div.className = `sheet ${mode === 'text' ? 'text-mode' : 'image-mode'}`;
        
        if (mode === 'text') {
            const body = document.createElement('div');
            body.className = 'markdown-body';
            div.appendChild(body);
        }
        
        const num = document.createElement('div');
        num.className = 'page-number';
        num.innerText = `- ${index} -`;
        div.appendChild(num);
        
        return div;
    }

    // æ‰“å°æ¨¡å¼ç­›é€‰
    function setPrintMode(mode) {
        document.body.classList.remove('print-odd', 'print-even');
        ['btnAll', 'btnOdd', 'btnEven'].forEach(id => document.getElementById(id).classList.remove('btn-active'));
        
        if (mode === 'all') document.getElementById('btnAll').classList.add('btn-active');
        if (mode === 'odd') {
            document.body.classList.add('print-odd');
            document.getElementById('btnOdd').classList.add('btn-active');
        }
        if (mode === 'even') {
            document.body.classList.add('print-even');
            document.getElementById('btnEven').classList.add('btn-active');
        }
    }

    // å±å¹•é€‚é…
    function fitToScreen() {
        const width = window.innerWidth - 20;
        const a4Width = 794; // approx px
        let scale = width / a4Width;
        if (scale > 1) scale = 1;
        scaler.style.transform = `scale(${scale})`;
        scaler.style.marginBottom = `-${(1-scale)*100}%`;
    }
    window.addEventListener('resize', fitToScreen);
</script>
</body>
</html>