<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Markdown A4 åŒé¢æ‰“å°å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* ---------- åŸºç¡€æ ·å¼ ---------- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body {
            margin: 0; padding: 0;
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f2f4f7;
            overflow: hidden; /* é˜²æ­¢æ•´ä½“æ»šåŠ¨ */
        }
        
        .app-container { display: flex; flex-direction: column; height: 100%; }

        /* ç¼–è¾‘å™¨åŒº */
        .editor-area {
            flex: 1; display: flex; flex-direction: column; background: #fff;
        }
        textarea {
            flex: 1; width: 100%; border: none; padding: 20px;
            font-size: 16px; line-height: 1.6; resize: none; outline: none;
        }

        /* é¢„è§ˆåŒº */
        .preview-area {
            flex: 1; display: none; /* é»˜è®¤éšè— */
            background: #525659; overflow-y: auto;
            flex-direction: column; align-items: center;
            padding: 20px 0 80px 0;
        }

        /* ç¼©æ”¾å®¹å™¨ */
        .scaler-container {
            transform-origin: top center;
            transition: transform 0.2s ease;
            display: flex; flex-direction: column; gap: 20px; /* é¡µé—´è· */
        }

        /* çº¸å¼ æ ·å¼ (ç‰©ç†åˆ†é¡µ) */
        .sheet {
            width: 210mm;
            height: 297mm; /* å¼ºåˆ¶å›ºå®šé«˜åº¦ï¼Œå®ç°ç²¾å‡†åˆ†é¡µ */
            background: white;
            padding: 20mm; /* é¡µè¾¹è· */
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            color: #000;
            overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡ºçº¸å¼  */
            position: relative;
        }

        /* é¡µç  */
        .page-number {
            position: absolute; bottom: 10mm; left: 0; width: 100%;
            text-align: center; color: #999; font-size: 12px;
            pointer-events: none;
        }

        /* åº•éƒ¨å·¥å…·æ  */
        .bottom-bar {
            height: auto; min-height: 60px; background: #fff;
            border-top: 1px solid #e0e0e0; padding: 10px 20px;
            display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between;
            z-index: 100; gap: 10px;
        }

        .btn-group { display: flex; gap: 8px; }
        .btn {
            border: 1px solid #ddd; background: #fff; padding: 8px 12px;
            border-radius: 6px; font-size: 14px; cursor: pointer;
        }
        .btn-primary { background: #007bff; color: #fff; border-color: #007bff; }
        .btn-active { background: #e7f1ff; color: #007bff; border-color: #007bff; font-weight: bold; }

        /* æ¨¡å¼åˆ‡æ¢ */
        body.mode-preview .editor-area { display: none; }
        body.mode-preview .preview-area { display: flex; }

        /* éšè—åŒº (ç”¨äºè®¡ç®— markdown åŸå§‹é«˜åº¦) */
        #temp-renderer {
            position: absolute; top: -9999px; left: -9999px;
            width: 170mm; /* A4å®½åº¦(210) - å·¦å³è¾¹è·(20+20) */
            visibility: hidden;
        }

        /* Markdown æ ·å¼ */
        .markdown-body { font-size: 11pt; line-height: 1.6; }
        .markdown-body h1 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 0; }
        .markdown-body table { width: 100%; border-collapse: collapse; margin-bottom: 1em; }
        .markdown-body th, .markdown-body td { border: 1px solid #ddd; padding: 8px; }
        .markdown-body pre { background: #f8f9fa; padding: 10px; white-space: pre-wrap; word-wrap: break-word; }
        .markdown-body img { max-width: 100%; }

        /* ==============================================
           æ‰“å°æ ¸å¿ƒæ ·å¼
           ============================================== */
        @media print {
            .editor-area, .bottom-bar { display: none !important; }
            html, body, .app-container, .preview-area, .scaler-container {
                height: auto !important; overflow: visible !important;
                background: white !important; margin: 0 !important; padding: 0 !important;
                display: block !important;
            }
            
            .scaler-container { transform: none !important; width: 100% !important; }

            .sheet {
                margin: 0 !important; box-shadow: none !important;
                page-break-after: always; /* å¼ºåˆ¶æ¯å¼ çº¸åæ¢é¡µ */
                width: 100% !important;
            }

            /* éšè—é¡µç  (å¯é€‰ï¼Œå¦‚æœä¸æƒ³æ‰“å°å‡ºæ¥) */
            /* .page-number { display: none; } */

            @page { size: A4; margin: 0; } /* è¾¹è·ç”± .sheet çš„ padding æ§åˆ¶ */

            /* --- å¥‡å¶é¡µæ§åˆ¶é€»è¾‘ --- */
            
            /* å¦‚æœé€‰æ‹©äº†åªæ‰“å°å¥‡æ•°é¡µ (1, 3, 5...) */
            body.print-odd .sheet:nth-child(even) {
                display: none !important;
            }

            /* å¦‚æœé€‰æ‹©äº†åªæ‰“å°å¶æ•°é¡µ (2, 4, 6...) */
            body.print-even .sheet:nth-child(odd) {
                display: none !important;
            }
        }
    </style>
</head>
<body>

<div class="app-container">
    <!-- ç¼–è¾‘å™¨ -->
    <div class="editor-area">
        <textarea id="input" placeholder="è¯·è¾“å…¥ Markdown å†…å®¹..."></textarea>
    </div>

    <!-- é¢„è§ˆåŒº -->
    <div class="preview-area" id="previewContainer">
        <div class="scaler-container" id="scaler">
            <!-- JS å°†ä¼šåœ¨è¿™é‡Œç”Ÿæˆå¤šä¸ª .sheet div -->
        </div>
    </div>

    <!-- ä¸´æ—¶æ¸²æŸ“åŒº (ç”¨äºè®¡ç®—é«˜åº¦) -->
    <div id="temp-renderer" class="markdown-body"></div>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <div class="bottom-bar">
        <div style="font-weight: bold; font-size: 14px;" id="pageInfo">å‡†å¤‡å°±ç»ª</div>
        
        <!-- ç¼–è¾‘æ¨¡å¼æŒ‰é’® -->
        <div class="btn-group" id="editControls">
            <button class="btn btn-primary" onclick="switchMode('preview')">ç”Ÿæˆé¢„è§ˆ</button>
        </div>

        <!-- é¢„è§ˆæ¨¡å¼æŒ‰é’® -->
        <div class="btn-group" id="previewControls" style="display:none;">
            <button class="btn" onclick="switchMode('edit')">âœï¸ è¿”å›</button>
            <div style="border-left:1px solid #ddd; margin:0 5px;"></div>
            
            <button class="btn btn-active" id="btnAll" onclick="setPrintMode('all')">å…¨éƒ¨</button>
            <button class="btn" id="btnOdd" onclick="setPrintMode('odd')">åªæ‰“å¥‡æ•° (1,3,5)</button>
            <button class="btn" id="btnEven" onclick="setPrintMode('even')">åªæ‰“å¶æ•° (2,4,6)</button>
            
            <button class="btn btn-primary" onclick="window.print()">ğŸ–¨ï¸ æ‰“å°</button>
        </div>
    </div>
</div>

<script>
    const input = document.getElementById('input');
    const scaler = document.getElementById('scaler');
    const tempRenderer = document.getElementById('temp-renderer');
    const pageInfo = document.getElementById('pageInfo');
    
    // é»˜è®¤æµ‹è¯•æ–‡æœ¬
    const defaultText = `# åŒé¢æ‰“å°æµ‹è¯•æŒ‡å—

è¿™æ˜¯ä¸€ä¸ªæ”¯æŒ**è‡ªåŠ¨åˆ†é¡µ**å’Œ**å¥‡å¶é¡µç­›é€‰**çš„å·¥å…·ã€‚

## å¦‚ä½•ä½¿ç”¨åŒé¢æ‰“å°ï¼Ÿ

1. ç‚¹å‡»ä¸‹æ–¹çš„ **"åªæ‰“å¥‡æ•°"**ã€‚
2. ç‚¹å‡» **"æ‰“å°"**ï¼Œæ‰“å°æœºå°†æ‰“å‡ºç¬¬ 1, 3, 5 é¡µã€‚
3. å°†æ‰“å°å¥½çš„çº¸æ•´ç†å¥½ï¼Œ**ç¿»é¢**æ”¾å›æ‰“å°æœºçº¸ç›’ï¼ˆæ³¨æ„çº¸å¼ æ–¹å‘ï¼‰ã€‚
4. ç‚¹å‡»ä¸‹æ–¹çš„ **"åªæ‰“å¶æ•°"**ã€‚
5. å†æ¬¡ **"æ‰“å°"**ï¼Œå°†æ‰“å‡ºç¬¬ 2, 4, 6 é¡µã€‚

## è‡ªåŠ¨åˆ†é¡µæµ‹è¯•
ä¸‹é¢æ˜¯å¡«å……å†…å®¹ï¼Œç”¨äºæ¼”ç¤ºå†…å®¹è¶…è¿‡ä¸€é¡µæ—¶å¦‚ä½•è‡ªåŠ¨åˆ‡åˆ†ã€‚

` + Array(40).fill(0).map((_,i) => `### ç¬¬ ${i+1} æ®µæµ‹è¯•å†…å®¹\nè¿™æ˜¯ç¬¬ ${i+1} æ®µè‡ªåŠ¨ç”Ÿæˆçš„æµ‹è¯•æ–‡æœ¬ï¼Œç”¨äºæµ‹è¯•åˆ†é¡µå™¨æ˜¯å¦èƒ½å‡†ç¡®åœ°å°†å†…å®¹åˆ‡å‰²åˆ°ä¸åŒçš„ A4 çº¸å¼ å®¹å™¨ä¸­ã€‚`).join('\n\n');

    input.value = defaultText;

    // å½“å‰æ‰“å°æ¨¡å¼
    let currentPrintMode = 'all';

    // æ ¸å¿ƒåŠŸèƒ½ï¼šå°† Markdown æ¸²æŸ“å¹¶ç‰©ç†åˆ‡å‰²æˆ A4 é¡µé¢
    function renderAndPaginate() {
        // 1. å…ˆæŠŠ Markdown è½¬ä¸º HTML æ”¾å…¥ä¸´æ—¶å®¹å™¨
        tempRenderer.innerHTML = marked.parse(input.value);
        
        // 2. æ¸…ç©ºé¢„è§ˆåŒº
        scaler.innerHTML = '';

        // 3. å®šä¹‰ A4 å†…å®¹åŒºé«˜åº¦é™åˆ¶ (mm è½¬ px, 297mm - 40mmè¾¹è· = 257mm)
        // ç²—ç•¥æ¢ç®—ï¼š1mm â‰ˆ 3.78px. 257mm â‰ˆ 970px.
        // ä¸ºäº†å®‰å…¨èµ·è§ï¼Œç•™ä¸€ç‚¹ bufferï¼Œè®¾ä¸º 960px
        const MAX_HEIGHT = 960; 

        // 4. åˆ›å»ºç¬¬ä¸€é¡µ
        let currentPageIndex = 1;
        let currentPage = createSheet(currentPageIndex);
        let currentHeight = 0;
        scaler.appendChild(currentPage);

        // 5. éå†ä¸´æ—¶å®¹å™¨çš„æ‰€æœ‰å­å…ƒç´ ï¼Œé€ä¸ªå¡å…¥é¡µé¢
        const elements = Array.from(tempRenderer.children);

        elements.forEach(el => {
            // è·å–å…ƒç´ é«˜åº¦
            // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦å…‹éš†èŠ‚ç‚¹å»è®¡ç®—ï¼Œå¦åˆ™ç§»èµ°å tempRenderer å°±ç©ºäº†
            // ç®€å•åšæ³•ï¼šç›´æ¥è¯»å– tempRenderer é‡Œçš„é«˜åº¦
            const elHeight = el.offsetHeight;
            const elStyle = window.getComputedStyle(el);
            const marginTop = parseFloat(elStyle.marginTop);
            const marginBottom = parseFloat(elStyle.marginBottom);
            const totalElHeight = elHeight + marginTop + marginBottom;

            // åˆ¤æ–­æ˜¯å¦æº¢å‡º
            if (currentHeight + totalElHeight > MAX_HEIGHT) {
                // æº¢å‡ºäº†ï¼Œåˆ›å»ºæ–°é¡µ
                currentPageIndex++;
                currentPage = createSheet(currentPageIndex);
                scaler.appendChild(currentPage);
                currentHeight = 0; // é‡ç½®å½“å‰é¡µé«˜åº¦
            }

            // å°†å…ƒç´ æ¬è¿åˆ°å½“å‰é¡µ (æ³¨æ„ï¼šappendChild ä¼šä» tempRenderer ç§»åŠ¨åˆ° currentPage)
            currentPage.querySelector('.markdown-body').appendChild(el);
            currentHeight += totalElHeight;
        });

        // æ›´æ–°çŠ¶æ€
        pageInfo.innerText = `å…±ç”Ÿæˆ ${currentPageIndex} é¡µ`;
    }

    // åˆ›å»ºä¸€å¼ ç©ºç™½çº¸çš„ Helper å‡½æ•°
    function createSheet(index) {
        const sheet = document.createElement('div');
        sheet.className = 'sheet';
        
        // å†…å®¹å®¹å™¨
        const content = document.createElement('div');
        content.className = 'markdown-body';
        sheet.appendChild(content);

        // é¡µç 
        const pageNum = document.createElement('div');
        pageNum.className = 'page-number';
        pageNum.innerText = `- ${index} -`;
        sheet.appendChild(pageNum);

        return sheet;
    }

    // è®¾ç½®æ‰“å°æ¨¡å¼ (all, odd, even)
    function setPrintMode(mode) {
        currentPrintMode = mode;
        document.body.classList.remove('print-odd', 'print-even');
        
        // æ›´æ–°æŒ‰é’®æ ·å¼
        ['btnAll', 'btnOdd', 'btnEven'].forEach(id => {
            document.getElementById(id).classList.remove('btn-active');
        });

        if (mode === 'all') {
            document.getElementById('btnAll').classList.add('btn-active');
        } else if (mode === 'odd') {
            document.body.classList.add('print-odd');
            document.getElementById('btnOdd').classList.add('btn-active');
        } else if (mode === 'even') {
            document.body.classList.add('print-even');
            document.getElementById('btnEven').classList.add('btn-active');
        }
    }

    // å±å¹•é€‚é…ç¼©æ”¾ (åŒä¸Šä¸€ç‰ˆ)
    function fitToScreen() {
        if (!document.body.classList.contains('mode-preview')) return;
        const a4WidthPx = 794; // 210mm @ 96dpi
        const screenWidth = window.innerWidth - 20; 
        let scale = screenWidth / a4WidthPx;
        if (scale > 1) scale = 1;

        scaler.style.transform = `scale(${scale})`;
        scaler.style.marginBottom = `-${(1 - scale) * 100}%`; // ä¿®æ­£åº•éƒ¨ç©ºç™½
    }

    // åˆ‡æ¢è§†å›¾æ¨¡å¼
    function switchMode(mode) {
        if (mode === 'preview') {
            renderAndPaginate(); // é‡æ–°è®¡ç®—åˆ†é¡µ
            document.body.classList.add('mode-preview');
            document.getElementById('editControls').style.display = 'none';
            document.getElementById('previewControls').style.display = 'flex';
            setPrintMode('all'); // é»˜è®¤é‡ç½®ä¸ºå…¨éƒ¨æ‰“å°
            setTimeout(fitToScreen, 50);
        } else {
            document.body.classList.remove('mode-preview');
            document.getElementById('editControls').style.display = 'flex';
            document.getElementById('previewControls').style.display = 'none';
            pageInfo.innerText = 'å‡†å¤‡å°±ç»ª';
        }
    }

    window.addEventListener('resize', fitToScreen);
</script>

</body>
</html>