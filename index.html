<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown A4 ç¼–è¾‘å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* ---------- åŸºç¡€æ ·å¼ (å±å¹•æµè§ˆç”¨) ---------- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        html, body {
            margin: 0; padding: 0;
            height: 100%; /* å±å¹•ä¸Šå æ»¡å…¨å± */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f2f4f7;
            overflow: hidden; /* å±å¹•ä¸Šç¦æ­¢æ•´ä½“æ»šåŠ¨ */
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        /* ç¼–è¾‘å™¨ */
        .editor-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
            overflow: hidden;
        }

        textarea {
            flex: 1;
            width: 100%;
            border: none;
            padding: 20px;
            font-size: 16px;
            line-height: 1.6;
            resize: none;
            outline: none;
            background: #fff;
            color: #333;
        }

        /* é¢„è§ˆåŒº */
        .preview-area {
            flex: 1;
            display: none; /* é»˜è®¤éšè— */
            background: #525659;
            overflow-y: auto; /* å±å¹•ä¸Šå…è®¸å†…éƒ¨æ»šåŠ¨ */
            align-items: center; /* æ”¹ä¸ºcenterä»¥ä¾¿å°å±å±…ä¸­ */
            justify-content: flex-start;
            padding-top: 20px;
            padding-bottom: 80px;
        }

        /* ç¼©æ”¾å®¹å™¨ */
        .a4-scaler {
            transform-origin: top center;
            transition: transform 0.2s ease;
            width: 100%; /* ç¡®ä¿å®¹å™¨æ»¡å®½ */
        }

        /* çº¸å¼ æœ¬ä½“ */
        .a4-page {
            width: 210mm;
            min-height: 297mm;
            background: white;
            padding: 20mm;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            color: #000;
            height: auto; 
            margin: 0 auto; /* å±…ä¸­ */
        }

        /* åº•éƒ¨æ“ä½œæ  */
        .bottom-bar {
            height: auto; /* å…è®¸é«˜åº¦è‡ªé€‚åº” */
            background: #fff;
            border-top: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 20px;
            z-index: 100;
            flex-shrink: 0;
        }

        /* çŠ¶æ€ä¸æŒ‰é’® */
        .status-text { font-size: 14px; color: #666; font-weight: 500; }
        .action-group { display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { border: none; border-radius: 6px; padding: 8px 16px; font-size: 14px; font-weight: 500; cursor: pointer; }
        .btn-primary { background: #007bff; color: #fff; }
        .btn-secondary { background: #f0f0f0; color: #333; }
        .checkbox-label { display: flex; align-items: center; gap: 5px; font-size: 14px; color: #333; }

        /* é¢„è§ˆæ¨¡å¼åˆ‡æ¢ */
        body.mode-preview .editor-area { display: none; }
        body.mode-preview .preview-area { display: flex; }

        /* Markdown æ ·å¼ */
        .markdown-body { font-size: 11pt; line-height: 1.6; }
        .markdown-body h1 { border-bottom: 2px solid #eee; padding-bottom: 10px; margin-top: 20px; }
        .markdown-body table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .markdown-body th, .markdown-body td { border: 1px solid #ddd; padding: 8px; }
        .markdown-body pre { background: #f8f9fa; padding: 10px; white-space: pre-wrap; word-wrap: break-word; }
        .markdown-body img { max-width: 100%; }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .preview-area {
                padding: 10px;
                background: #fff;
                justify-content: flex-start;
                align-items: stretch;
            }
            .a4-scaler {
                transform: none !important;
            }
            .a4-page {
                width: 100% !important;
                min-height: auto !important;
                padding: 10mm !important;
                box-shadow: none;
            }
            .bottom-bar {
                flex-direction: column;
                align-items: flex-start;
            }
            .action-group {
                flex-direction: column;
                width: 100%;
            }
            .btn {
                width: 100%;
                padding: 12px;
                font-size: 16px;
            }
        }

        /* æ‰“å°æ ·å¼ */
        @media print {
            .editor-area, .bottom-bar, .action-group { display: none !important; }
            html, body { height: auto !important; overflow: visible !important; background: white !important; margin: 0 !important; padding: 0 !important; }
            .app-container { display: block !important; height: auto !important; overflow: visible !important; }
            .preview-area { display: block !important; height: auto !important; overflow: visible !important; background: white !important; padding: 0 !important; margin: 0 !important; }
            .a4-scaler { transform: none !important; width: 100% !important; height: auto !important; margin: 0 !important; padding: 0 !important; }
            .a4-page { width: 100% !important; height: auto !important; min-height: 0 !important; margin: 0 !important; padding: 0 !important; box-shadow: none !important; border: none !important; }
            @page { size: A4; margin: 20mm; }
            h1, h2, h3 { page-break-after: avoid; }
            table, pre, blockquote { page-break-inside: avoid; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="editor-area">
            <textarea id="input"></textarea>
        </div>
        <div class="preview-area">
            <div id="scaler" class="a4-scaler">
                <div id="output" class="a4-page markdown-body"></div>
            </div>
        </div>
        <div class="bottom-bar">
            <div class="status-text" id="statusLabel">ç¼–è¾‘ä¸­</div>
            <div class="action-group">
                <input type="file" id="imageUpload" accept="image/*" multiple style="display:none;">
                <button id="btnUploadImage" class="btn btn-secondary">ä¸Šä¼ å›¾ç‰‡</button>
                <button id="btnToPreview" class="btn btn-primary">é¢„è§ˆ</button>
                <button id="btnToEdit" class="btn btn-secondary" style="display:none;">ç¼–è¾‘</button>
                <button id="btnPrint" class="btn btn-primary" style="display:none;">ğŸ–¨ï¸ æ‰“å°æ‰€æœ‰é¡µ</button>
                <button id="btnPrintOdd" class="btn btn-primary" style="display:none;">æ‰“å°å¥‡æ•°é¡µ</button>
                <button id="btnPrintEven" class="btn btn-primary" style="display:none;">æ‰“å°å¶æ•°é¡µ</button>
                <label id="reverseEvenLabel" class="checkbox-label" style="display:none;"><input type="checkbox" id="reverseEven"> åè½¬å¶æ•°é¡µé¡ºåº</label>
            </div>
        </div>
    </div>

    <script>
        const input = document.getElementById('input');
        const output = document.getElementById('output');
        const scaler = document.getElementById('scaler');
        const previewArea = document.querySelector('.preview-area');
        const statusLabel = document.getElementById('statusLabel');
        const btnToPreview = document.getElementById('btnToPreview');
        const btnToEdit = document.getElementById('btnToEdit');
        const btnPrint = document.getElementById('btnPrint');
        const btnPrintOdd = document.getElementById('btnPrintOdd');
        const btnPrintEven = document.getElementById('btnPrintEven');
        const imageUpload = document.getElementById('imageUpload');
        const btnUploadImage = document.getElementById('btnUploadImage');
        const reverseEven = document.getElementById('reverseEven');
        const reverseEvenLabel = document.getElementById('reverseEvenLabel');

        // æµ‹è¯•æ–‡æœ¬
        let longText = "# å¤šé¡µæ‰“å°æµ‹è¯•\n\næ­¤æ–‡æ¡£ç”¨äºæµ‹è¯•é•¿å†…å®¹æ˜¯å¦ä¼šè¢«æˆªæ–­ã€‚\n\n";
        for(let i=1; i<100; i++) longText += `æ®µè½ ${i}: è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ®µè½ï¼Œç”¨äºå¡«å……å†…å®¹ã€‚\n\n`;
        input.value = longText;

        function render() {
            output.innerHTML = marked.parse(input.value);
        }

        function fitToScreen() {
            if (window.innerWidth > 768) {
                const availableHeight = previewArea.clientHeight - 100;
                const pageHeight = scaler.offsetHeight;
                let scale = availableHeight / pageHeight;
                if (scale > 1) scale = 1;
                scaler.style.transform = `scale(${scale})`;
                scaler.style.marginBottom = `-${(1 - scale) * 100}%`;
            } else {
                scaler.style.transform = 'scale(1)';
                scaler.style.marginBottom = '0';
            }
        }

        function switchMode(mode) {
            if (mode === 'preview') {
                render();
                document.body.classList.add('mode-preview');
                statusLabel.innerText = "é¢„è§ˆæ¨¡å¼";
                btnToPreview.style.display = 'none';
                btnToEdit.style.display = 'block';
                btnPrint.style.display = 'block';
                btnPrintOdd.style.display = 'block';
                btnPrintEven.style.display = 'block';
                btnUploadImage.style.display = 'none';
                reverseEvenLabel.style.display = 'block';
                setTimeout(fitToScreen, 10);
            } else {
                document.body.classList.remove('mode-preview');
                statusLabel.innerText = "ç¼–è¾‘ä¸­";
                btnToPreview.style.display = 'block';
                btnToEdit.style.display = 'none';
                btnPrint.style.display = 'none';
                btnPrintOdd.style.display = 'none';
                btnPrintEven.style.display = 'none';
                btnUploadImage.style.display = 'block';
                reverseEvenLabel.style.display = 'none';
            }
        }

        function calculatePages() {
            const calib = document.createElement('div');
            calib.style.height = '1mm';
            calib.style.position = 'absolute';
            calib.style.visibility = 'hidden';
            document.body.appendChild(calib);
            const pxPerMm = calib.offsetHeight;
            document.body.removeChild(calib);

            const page = document.querySelector('.a4-page');
            const paddingMm = 20 * 2;
            const contentHeightPx = page.offsetHeight - (paddingMm * pxPerMm);
            const contentHeightMm = contentHeightPx / pxPerMm;
            const pageContentHeightMm = 297 - 40;
            return Math.ceil(contentHeightMm / pageContentHeightMm);
        }

        // å›¾ç‰‡ä¸Šä¼ 
        btnUploadImage.addEventListener('click', () => imageUpload.click());
        imageUpload.addEventListener('change', (event) => {
            const files = event.target.files;
            if (files.length > 0) {
                let markdownImages = '';
                let loadedCount = 0;
                Array.from(files).forEach((file, index) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        markdownImages += `![Image \( {index + 1}]( \){e.target.result})\n\n`;
                        loadedCount++;
                        if (loadedCount === files.length) {
                            input.value += markdownImages;
                            render();
                            input.focus();
                        }
                    };
                    reader.readAsDataURL(file);
                });
            }
        });

        btnToPreview.addEventListener('click', () => switchMode('preview'));
        btnToEdit.addEventListener('click', () => switchMode('edit'));

        btnPrint.addEventListener('click', () => {
            switchMode('preview');
            window.print();
        });

        btnPrintOdd.addEventListener('click', () => {
            switchMode('preview');
            const pages = calculatePages();
            const odd = Array.from({length: pages}, (_, i) => i + 1).filter(n => n % 2 === 1);
            const oddStr = odd.join(',');
            alert(`è¾“å…¥é¡µç : ${oddStr}`);
            window.print();
        });

        btnPrintEven.addEventListener('click', () => {
            switchMode('preview');
            const pages = calculatePages();
            let even = Array.from({length: pages}, (_, i) => i + 1).filter(n => n % 2 === 0);
            if (reverseEven.checked) even.reverse();
            const evenStr = even.join(',');
            alert(`è¾“å…¥é¡µç : ${evenStr}`);
            window.print();
        });

        input.addEventListener('input', render);
        window.addEventListener('resize', fitToScreen);
        render();
    </script>
</body>
</html>