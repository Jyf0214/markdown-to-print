<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Markdown A4 å®Œç¾åˆ†é¡µç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* ---------- åŸºç¡€æ ·å¼ ---------- */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body {
            margin: 0; padding: 0;
            height: 100%;
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif; /* ä½¿ç”¨é€šç”¨å®‰å…¨å­—ä½“ */
            background-color: #f2f4f7;
            overflow: hidden;
        }
        
        .app-container { display: flex; flex-direction: column; height: 100%; }

        /* ç¼–è¾‘å™¨ */
        .editor-area {
            flex: 1; display: flex; flex-direction: column; background: #fff;
        }
        textarea {
            flex: 1; width: 100%; border: none; padding: 15px;
            font-size: 16px; line-height: 1.5; resize: none; outline: none;
        }

        /* é¢„è§ˆåŒº */
        .preview-area {
            flex: 1; display: none;
            background: #525659; overflow-y: auto;
            flex-direction: column; align-items: center;
            padding: 20px 0 100px 0;
        }

        .scaler-container {
            transform-origin: top center;
            transition: transform 0.2s ease;
            display: flex; flex-direction: column; gap: 15px;
        }

        /* çº¸å¼  (å±å¹•é¢„è§ˆ) */
        .sheet {
            width: 210mm;
            height: 297mm; /* å±å¹•ä¸Šå›ºå®šé«˜åº¦ï¼Œæ¨¡æ‹ŸçœŸå®çº¸å¼  */
            background: white;
            padding: 20mm;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            color: #000;
            position: relative;
            overflow: hidden; /* é¢„è§ˆæ—¶éšè—æº¢å‡ºï¼Œæ‰“å°æ—¶è§£é™¤ */
        }

        /* é¡µç  */
        .page-number {
            position: absolute; bottom: 10mm; left: 0; width: 100%;
            text-align: center; color: #999; font-size: 10pt;
            pointer-events: none;
        }

        /* åº•éƒ¨å·¥å…·æ  */
        .bottom-bar {
            background: #fff; border-top: 1px solid #e0e0e0;
            padding: 10px 15px; z-index: 100;
            display: flex; flex-direction: column; gap: 10px;
        }

        .controls-row {
            display: flex; justify-content: space-between; align-items: center; width: 100%;
        }

        /* æ»‘å—æ ·å¼ */
        .slider-container {
            display: flex; align-items: center; gap: 10px; width: 100%;
            background: #f8f9fa; padding: 8px; border-radius: 6px;
            font-size: 12px; color: #555;
        }
        input[type=range] { flex: 1; }

        .btn-group { display: flex; gap: 8px; flex-wrap: wrap; }
        .btn {
            border: 1px solid #ddd; background: #fff; padding: 8px 10px;
            border-radius: 4px; font-size: 13px; cursor: pointer; flex: 1; text-align: center;
        }
        .btn-primary { background: #007bff; color: #fff; border-color: #007bff; }
        .btn-active { background: #e7f1ff; color: #007bff; border-color: #007bff; font-weight: bold; }

        /* çŠ¶æ€åˆ‡æ¢ */
        body.mode-preview .editor-area { display: none; }
        body.mode-preview .preview-area { display: flex; }

        /* éšè—è®¡ç®—åŒº */
        #temp-renderer {
            position: absolute; top: 0; left: 0; width: 170mm; /* A4å®½åº¦-è¾¹è· */
            visibility: hidden; pointer-events: none; z-index: -1;
        }

        /* ---------- Markdown æ‰“å°ä¸“ç”¨æ ·å¼ (å•ä½ä½¿ç”¨ pt) ---------- */
        .markdown-body { 
            font-size: 11pt; /* ä½¿ç”¨ pt å•ä½ï¼Œæ‰“å°æ›´å‡†ç¡® */
            line-height: 1.5; 
            color: #000;
        }
        .markdown-body h1 { border-bottom: 2px solid #eee; padding-bottom: 0.3em; font-size: 18pt; margin: 0 0 10pt 0; }
        .markdown-body h2 { border-bottom: 1px solid #eee; padding-bottom: 0.3em; font-size: 15pt; margin: 15pt 0 10pt 0; }
        .markdown-body h3 { font-size: 13pt; margin: 12pt 0 8pt 0; }
        .markdown-body p { margin-bottom: 10pt; text-align: justify; } /* ä¸¤ç«¯å¯¹é½ï¼Œæ‰“å°æ›´å¥½çœ‹ */
        .markdown-body table { width: 100%; border-collapse: collapse; margin-bottom: 12pt; }
        .markdown-body th, .markdown-body td { border: 1px solid #000; padding: 6pt; font-size: 10pt; }
        .markdown-body img { max-width: 100%; }
        .markdown-body pre { background: #f0f0f0; padding: 8pt; border-radius: 4px; font-size: 10pt; font-family: monospace; white-space: pre-wrap; }

        /* ==================== æ‰“å°è§„åˆ™ ==================== */
        @media print {
            .editor-area, .bottom-bar { display: none !important; }
            html, body, .app-container, .preview-area, .scaler-container {
                height: auto !important; overflow: visible !important;
                background: white !important; margin: 0 !important; padding: 0 !important;
                display: block !important;
            }
            .scaler-container { transform: none !important; width: 100% !important; }
            
            .sheet {
                margin: 0 !important; box-shadow: none !important; border: none !important;
                width: 100% !important; height: auto !important; /* æ‰“å°æ—¶é«˜åº¦è‡ªé€‚åº”ï¼Œé˜²æ­¢å†…å®¹è¢«åˆ‡ */
                page-break-after: always; /* å¼ºåˆ¶åˆ†é¡µ */
                overflow: visible !important;
            }

            /* å¥‡å¶é¡µæ§åˆ¶ */
            body.print-odd .sheet:nth-child(even) { display: none !important; }
            body.print-even .sheet:nth-child(odd) { display: none !important; }

            @page { size: A4; margin: 0; } /* è¾¹è·ç”± padding æ§åˆ¶ */
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="editor-area">
        <textarea id="input" placeholder="è¾“å…¥ Markdown..."></textarea>
    </div>

    <div class="preview-area" id="previewContainer">
        <div class="scaler-container" id="scaler"></div>
    </div>

    <div id="temp-renderer" class="markdown-body"></div>

    <div class="bottom-bar">
        <!-- è°ƒèŠ‚å¯†åº¦çš„æ»‘å— (ä»…åœ¨é¢„è§ˆæ¨¡å¼æ˜¾ç¤º) -->
        <div class="slider-container" id="densityControl" style="display: none;">
            <span>å¡«å……å¯†åº¦:</span>
            <input type="range" id="densitySlider" min="80" max="150" value="100">
            <span id="densityVal">100%</span>
            <div style="font-size:10px; color:#999; margin-left:5px;">(å¦‚æœç©ºéš™å¤§å¾€å³æ‹‰)</div>
        </div>

        <div class="controls-row">
            <div id="infoText" style="font-size: 12px; color: #666;">ç¼–è¾‘æ¨¡å¼</div>
            
            <!-- ç¼–è¾‘æ¨¡å¼æŒ‰é’® -->
            <div class="btn-group" id="editControls">
                <button class="btn btn-primary" onclick="switchMode('preview')">é¢„è§ˆå¹¶åˆ†é¡µ</button>
            </div>

            <!-- é¢„è§ˆæ¨¡å¼æŒ‰é’® -->
            <div class="btn-group" id="previewControls" style="display:none;">
                <button class="btn" onclick="switchMode('edit')">è¿”å›</button>
                <button class="btn btn-active" id="btnAll" onclick="setPrintMode('all')">å…¨éƒ¨</button>
                <button class="btn" id="btnOdd" onclick="setPrintMode('odd')">å¥‡æ•°(æ­£é¢)</button>
                <button class="btn" id="btnEven" onclick="setPrintMode('even')">å¶æ•°(åé¢)</button>
                <button class="btn btn-primary" onclick="window.print()">ğŸ–¨ï¸</button>
            </div>
        </div>
    </div>
</div>

<script>
    const input = document.getElementById('input');
    const scaler = document.getElementById('scaler');
    const tempRenderer = document.getElementById('temp-renderer');
    const densitySlider = document.getElementById('densitySlider');
    const densityVal = document.getElementById('densityVal');
    
    // é»˜è®¤æµ‹è¯•å†…å®¹
    let defaultText = `# å¥‡å¶é¡µæ‰“å°ä¿®å¤ç‰ˆ

## é‡åˆ°"æå‰æ¢é¡µ"æ€ä¹ˆåŠï¼Ÿ
å¦‚æœä½ å‘ç°é¡µé¢ä¸‹æ–¹è¿˜æœ‰å¾ˆå¤§ç©ºç™½ï¼Œä½†å†…å®¹å´è·³åˆ°äº†ä¸‹ä¸€é¡µï¼š

1. è¯·æ‹–åŠ¨ä¸‹æ–¹çš„ **"å¡«å……å¯†åº¦"** æ»‘å—ã€‚
2. **å‘å³æ‹–åŠ¨**ï¼šå¼ºåˆ¶å¡å…¥æ›´å¤šå†…å®¹ï¼ˆè§£å†³æˆªæ–­é—®é¢˜ï¼‰ã€‚
3. **å‘å·¦æ‹–åŠ¨**ï¼šå‡å°‘æ¯é¡µå†…å®¹ï¼ˆè§£å†³æº¢å‡ºé—®é¢˜ï¼‰ã€‚

æ­¤æ»‘å—ä¼šè°ƒæ•´è®¡ç®—é€»è¾‘ï¼Œé€‚é…ä¸åŒæ‰‹æœºçš„æ‰“å°å¼•æ“ã€‚

---
`;
    // ç”Ÿæˆé•¿å†…å®¹
    for(let i=1; i<=20; i++) {
        defaultText += `### ç¬¬ ${i} èŠ‚æµ‹è¯•\nè¿™æ˜¯æµ‹è¯•æ®µè½ã€‚æˆ‘ä»¬ä¼šç”¨è¶³å¤Ÿå¤šçš„æ–‡å­—æ¥å¡«æ»¡é¡µé¢ï¼Œä»¥ä¾¿æµ‹è¯•åˆ†é¡µç®—æ³•çš„å‡†ç¡®æ€§ã€‚å¦‚æœç®—æ³•å¤ªä¿å®ˆï¼Œè¿™é‡Œå°±ä¼šå‡ºç°å¤§ç‰‡ç©ºç™½ã€‚å¦‚æœå¤ªæ¿€è¿›ï¼Œå†…å®¹å°±ä¼šæº¢å‡ºçº¸å¼ è¾¹ç•Œã€‚\n\n`;
    }
    input.value = defaultText;

    let currentPrintMode = 'all';
    let densityRatio = 1.0; // å¯†åº¦ç³»æ•°

    // æ ¸å¿ƒåˆ†é¡µé€»è¾‘
    function renderAndPaginate() {
        // 1. æ¸²æŸ“ HTML
        tempRenderer.innerHTML = marked.parse(input.value);
        scaler.innerHTML = '';

        // 2. è®¡ç®—é¡µé¢å®¹é‡
        // A4 é«˜åº¦ 297mmï¼Œä¸Šä¸‹è¾¹è·å„ 20mm -> å†…å®¹é«˜åº¦ 257mm
        // è·å–å‚è€ƒ div çš„åƒç´ é«˜åº¦ (ä¸åŒå±å¹• dpi ç»“æœä¸åŒ)
        const refDiv = document.createElement('div');
        refDiv.style.height = '257mm'; 
        document.body.appendChild(refDiv);
        const basePageHeight = refDiv.offsetHeight;
        document.body.removeChild(refDiv);

        // 3. åº”ç”¨å¯†åº¦ç³»æ•° (æ ¸å¿ƒä¿®å¤ç‚¹)
        // å¦‚æœç”¨æˆ·å¾€å³æ‹‰ (ratio > 1)ï¼Œæˆ‘ä»¬è®¤ä¸ºé¡µé¢"å˜é«˜äº†"ï¼Œèƒ½è£…æ›´å¤šä¸œè¥¿
        const MAX_HEIGHT = basePageHeight * densityRatio;

        let currentPageIndex = 1;
        let currentPage = createSheet(currentPageIndex);
        let currentHeight = 0;
        let contentContainer = currentPage.querySelector('.markdown-body');
        
        scaler.appendChild(currentPage);

        const elements = Array.from(tempRenderer.children);

        elements.forEach(el => {
            // è·å–å…ƒç´ åŒ…å« margin çš„æ€»é«˜åº¦
            const height = el.getBoundingClientRect().height;
            const style = window.getComputedStyle(el);
            const margin = parseFloat(style.marginTop) + parseFloat(style.marginBottom);
            const totalH = height + margin;

            // æ£€æŸ¥æ˜¯å¦éœ€è¦æ¢é¡µ
            // å®¹é”™ 5px
            if (currentHeight + totalH > MAX_HEIGHT - 5) {
                currentPageIndex++;
                currentPage = createSheet(currentPageIndex);
                scaler.appendChild(currentPage);
                contentContainer = currentPage.querySelector('.markdown-body');
                currentHeight = 0;
            }

            // æ¬è¿å…ƒç´ 
            contentContainer.appendChild(el);
            currentHeight += totalH;
        });

        document.getElementById('infoText').innerText = `å…± ${currentPageIndex} é¡µ (å¯†åº¦: ${Math.round(densityRatio*100)}%)`;
    }

    function createSheet(index) {
        const sheet = document.createElement('div');
        sheet.className = 'sheet';
        sheet.innerHTML = `<div class="markdown-body"></div><div class="page-number">- ${index} -</div>`;
        return sheet;
    }

    function setPrintMode(mode) {
        currentPrintMode = mode;
        document.body.classList.remove('print-odd', 'print-even');
        ['btnAll', 'btnOdd', 'btnEven'].forEach(id => document.getElementById(id).classList.remove('btn-active'));

        if (mode === 'all') {
            document.getElementById('btnAll').classList.add('btn-active');
        } else if (mode === 'odd') {
            document.body.classList.add('print-odd');
            document.getElementById('btnOdd').classList.add('btn-active');
        } else if (mode === 'even') {
            document.body.classList.add('print-even');
            document.getElementById('btnEven').classList.add('btn-active');
        }
    }

    function fitToScreen() {
        if (!document.body.classList.contains('mode-preview')) return;
        const screenWidth = window.innerWidth - 30; // ç•™ç‚¹è¾¹
        // A4 210mm å¯¹åº”çš„åƒç´ å®½ (å¤§æ¦‚å€¼ï¼Œç”¨äºç¼©æ”¾æ¯”ä¾‹)
        const a4Px = document.querySelector('.sheet') ? document.querySelector('.sheet').offsetWidth : 794;
        let scale = screenWidth / a4Px;
        if (scale > 1) scale = 1;
        scaler.style.transform = `scale(${scale})`;
        scaler.style.marginBottom = `-${(1 - scale) * 100}%`;
    }

    function switchMode(mode) {
        if (mode === 'preview') {
            renderAndPaginate();
            document.body.classList.add('mode-preview');
            document.getElementById('editControls').style.display = 'none';
            document.getElementById('previewControls').style.display = 'flex';
            document.getElementById('densityControl').style.display = 'flex'; // æ˜¾ç¤ºæ»‘å—
            setPrintMode('all');
            setTimeout(fitToScreen, 50);
        } else {
            document.body.classList.remove('mode-preview');
            document.getElementById('editControls').style.display = 'flex';
            document.getElementById('previewControls').style.display = 'none';
            document.getElementById('densityControl').style.display = 'none';
        }
    }

    // æ»‘å—ç›‘å¬
    densitySlider.addEventListener('input', (e) => {
        const val = e.target.value;
        densityVal.innerText = val + "%";
        densityRatio = val / 100;
        // é˜²æŠ–é‡æ–°æ¸²æŸ“ï¼Œé¿å…å¡é¡¿
        if(window.renderTimeout) clearTimeout(window.renderTimeout);
        window.renderTimeout = setTimeout(() => {
            renderAndPaginate();
        }, 100);
    });

    window.addEventListener('resize', fitToScreen);
</script>
</body>
</html>